<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Squid Game - Gestion des Joueurs</title>
  <style>
    @font-face {
      font-family: "GameOfSquids";
      src: url("https://ik.imagekit.io/lakolo/GameOfSquids-1GMVL.ttf");
    }
    @font-face {
      font-family: "PlayerFont";
      src: url("https://ik.imagekit.io/lakolo/JMH%20Beda.ttf");
    }

    body {
      font-family: "GameOfSquids", sans-serif;
      background-color: #101010;
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 3rem;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      color: white;
    }
    h1 span {
      display: inline-block;
      font-family: "GameOfSquids", sans-serif;
      font-size: 3rem;
    }
    h1 span.shape-circle {
      color: #ff3e68;
    }
    h1 span.shape-triangle {
      color: #ff3e68;
    }
    h1 span.shape-square {
      color: #ff3e68;
      transform: scale(1.4);
      display: inline-block;
    }

    /* Container principal des joueurs */
    #players-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .player-card {
      width: 80px;
      height: 120px;
      border: 2px solid white;
      border-radius: 5px;
      background-color: #007575;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      cursor: pointer;
      font-family: "PlayerFont", sans-serif;
      position: relative;
    }
    .player-card.active {
      border-color: limegreen;
      background-color: #0a0;
    }
    .player-card.no-lives {
      background-color: #505050 !important;
      opacity: 0.7;
    }

    .player-card-number {
      font-size: 2rem;
      color: white;
      background-color: #005050;
      padding: 5px 10px;
      border: 2px solid white;
      border-radius: 5px;
    }
    .player-lives {
      font-size: 1.6rem;
      color: white;
      margin-top: 5px;
    }

    /* Boutons en bas */
    .buttons-container {
      margin-top: 400px;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 20px 10px;
      font-family: "GameOfSquids", sans-serif;
    }
    #submit-btn {
      background-color: #ff3e68;
      color: white;
    }
    #submit-btn:hover {
      background-color: #c32d4e;
    }
    #reset-btn {
      background-color: #32cd32;
      color: white;
    }
    #reset-btn:hover {
      background-color: #228b22;
    }
    #undo-btn {
      background-color: #888;
      color: white;
    }
    #undo-btn:hover {
      background-color: #555;
    }
    #voice-btn {
      background-color: #3f51b5;
      color: white;
    }
    #voice-btn:hover {
      background-color: #303f9f;
    }
    #teams-btn {
      background-color: #ffcc00;
      color: #000;
    }
    #teams-btn:hover {
      background-color: #e6b800;
    }
    #break-teams-btn {
      background-color: #777;
      color: white;
    }
    #break-teams-btn:hover {
      background-color: #555;
    }

    #lives-input {
      padding: 10px;
      font-size: 1.2rem;
      border-radius: 5px;
      border: 1px solid #fff;
      margin: 20px;
      background-color: #202020;
      color: #fff;
    }

    /* Effet d'animation pour la perte de vie */
    .minus-life {
      position: absolute;
      color: red;
      font-size: 1.5rem;
      font-weight: bold;
      opacity: 1;
      transform: translate(-50%, 0);
      pointer-events: none;
    }

    /* Overlay pour les gagnants */
    #winners-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.9);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }
    .winner-clone {
      width: 140px;
      height: 200px;
      margin: 10px;
      background-color: #007575;
      border: 3px solid #fff;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadein 0.3s ease;
    }
    .winner-clone .clone-number {
      font-size: 3rem;
      background-color: #005050;
      color: #fff;
      border: 2px solid #fff;
      border-radius: 5px;
      padding: 5px 10px;
      margin: 5px;
    }
    .winner-clone .clone-lives {
      font-size: 1.5rem;
      color: #fff;
      margin-top: 5px;
    }
    @keyframes fadein {
      from { transform: scale(0.8); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    /* Overlay pour le décompte */
    #countdown-overlay {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background-color: rgba(0,0,0,0.8);
      z-index: 999999;
      justify-content: center;
      align-items: center;
    }
    #countdown-number {
      font-size: 8rem;
      color: #ff3e68;
      font-family: "GameOfSquids", sans-serif;
    }

    /* Conteneur des équipes => flex horizontal (pas de scroll vertical si possible) */
    #teams-container {
      display: none;
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .team-box {
      border: 2px dashed #aaa;
      border-radius: 5px;
      padding: 10px;
      min-width: 200px;
    }
    .team-box h2 {
      font-family: "GameOfSquids", sans-serif;
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #ffcc00;
    }
    .team-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

  </style>
</head>
<body>
<h1>
  <span>SQUID</span>
  <span class="shape-circle">O</span>
  <span class="shape-triangle">Δ</span>
  <span class="shape-square">■</span>
  <span>GAME</span>
</h1>
<p>À qui le tour ?</p>

<!-- Overlay gagnants -->
<div id="winners-overlay"></div>

<!-- Overlay décompte -->
<div id="countdown-overlay">
  <div id="countdown-number">3</div>
</div>

<!-- Container principal (joueurs) -->
<div id="players-container"></div>

<!-- Container final (équipes) -->
<div id="teams-container"></div>

<div class="buttons-container">
  <input id="lives-input" type="number" placeholder="Vies à supprimer" min="1" />
  <button id="submit-btn" onclick="processRound()">Soumettre les gagnants</button>
  <button id="reset-btn" onclick="confirmReset()">Réinitialiser les vies</button>
  <button id="undo-btn" onclick="undoAction()">Retour</button>
  <button id="voice-btn" onclick="toggleVoiceRecognition()">Activer la Reconnaissance Vocale</button>

  <!-- Bouton Créer Equipes -->
  <button id="teams-btn" onclick="createTeams()">Créer les équipes</button>

  <!-- Bouton Casser Equipes -->
  <button id="break-teams-btn" onclick="breakTeams()">Casser les équipes</button>
</div>

<script>
  // ------------------------------------------------
  // Paramètres init
  const urlParams = new URLSearchParams(window.location.search);
  const numPlayers = parseInt(urlParams.get('players'), 10) || 12;
  let players = Array.from({ length: numPlayers }, (_, i)=>({
    id: i+1,
    lives: 6,
    isWinner: false
  }));
  let lastPlayers = null;

  // ------------------------------------------------
  // Sauvegarde / Undo
  function saveState(){
    lastPlayers = JSON.parse(JSON.stringify(players));
  }
  function undoAction(){
    if(!lastPlayers) {
      console.warn("Aucune action à annuler");
      return;
    }
    players = JSON.parse(JSON.stringify(lastPlayers));
    hideWinners();
    renderPlayers();
  }

  // ------------------------------------------------
  // Lecture Audio Fond
  const audio = new Audio("https://ik.imagekit.io/lakolo/Squid%20Game%20%20Piggy%20Bank%20Scene.mp3?updatedAt=1737407404597");
  audio.volume = 1.0;
  let fadeInterval = null;

  function playAudioFadeIn(){
    if(fadeInterval) clearInterval(fadeInterval);
    audio.pause();
    audio.currentTime = 0;
    audio.volume=0;
    audio.play().catch(err=>console.warn("Impossible audio:", err));
    fadeInterval = setInterval(()=>{
      if(audio.volume<1){
        audio.volume = Math.min(audio.volume+0.1,1);
      } else {
        clearInterval(fadeInterval);
        fadeInterval=null;
      }
    }, 200);
  }
  function stopAudioFadeOut(){
    if(fadeInterval) clearInterval(fadeInterval);
    fadeInterval = setInterval(()=>{
      if(audio.volume>0.1){
        audio.volume-=0.1;
      } else {
        audio.pause();
        audio.currentTime=0;
        clearInterval(fadeInterval);
        fadeInterval=null;
      }
    },200);
  }

  // ------------------------------------------------
  // Render Joueurs
  function renderPlayers(){
    const container = document.getElementById('players-container');
    container.innerHTML='';
    container.style.display='flex'; // On s'assure de réafficher si besoin

    players.forEach(player=>{
      let cardClass='player-card';
      if(player.isWinner) cardClass+=' active';
      if(player.lives<=0) cardClass+=' no-lives';

      const playerCard=document.createElement('div');
      playerCard.className=cardClass;
      playerCard.onclick=()=>toggleWinnerManually(player.id);

      const playerNumber=document.createElement('div');
      playerNumber.className='player-card-number';
      playerNumber.textContent=player.id.toString().padStart(3,'0');

      const playerLives=document.createElement('div');
      playerLives.className='player-lives';
      playerLives.textContent=`Vies: ${player.lives}`;

      playerCard.appendChild(playerNumber);
      playerCard.appendChild(playerLives);
      container.appendChild(playerCard);
    });
  }
  function toggleWinnerManually(pid){
    saveState();
    const pl=players.find(p=>p.id===pid);
    if(!pl)return;
    pl.isWinner=!pl.isWinner;
    renderPlayers();
  }
  function toggleWinner(pid){
    saveState();
    const p=players.find(x=>x.id===pid);
    if(!p)return;
    p.isWinner=!p.isWinner;
    renderPlayers();
    showWinners();
  }
  function toggleWinnerInstant(pid){
    saveState();
    const p=players.find(x=>x.id===pid);
    if(!p)return;
    p.isWinner=true;
    renderPlayers();
    showWinners();
  }

  // ------------------------------------------------
  // Round / Gagnants
  function processRound(){
    saveState();
    hideWinners();
    const livesToRemove = parseInt(document.getElementById('lives-input').value)||1;
    players.forEach(p=>{
      if(!p.isWinner && p.lives>0){
        p.lives-=livesToRemove;
        if(p.lives<0)p.lives=0;
      }
      p.isWinner=false;
    });
    renderPlayers();
  }
  function confirmReset(){
    const sure=confirm("Êtes-vous sûr de vouloir réinitialiser ?");
    if(!sure)return;
    saveState();
    hideWinners();
    players.forEach(p=>{
      p.lives=6;
      p.isWinner=false;
    });
    renderPlayers();
  }

  function showWinners(){
    const overlay=document.getElementById('winners-overlay');
    overlay.innerHTML='';
    const winners=players.filter(p=>p.isWinner);
    if(!winners.length){
      overlay.style.display='none';
      return;
    }
    // on masque les cartes correspondantes
    const children=document.querySelectorAll('#players-container .player-card');
    children.forEach(cd=>{
      const num=cd.querySelector('.player-card-number').textContent;
      const id=parseInt(num,10);
      const pl=players.find(x=>x.id===id);
      if(pl && pl.isWinner){
        cd.style.display='none';
      }
    });

    winners.forEach(w=>{
      const clone=document.createElement('div');
      clone.className='winner-clone';
      clone.onclick=()=>{
        saveState();
        w.isWinner=false;
        hideWinners();
        renderPlayers();
      };

      const cloneNumber=document.createElement('div');
      cloneNumber.className='clone-number';
      cloneNumber.textContent=w.id.toString().padStart(3,'0');

      const cloneLives=document.createElement('div');
      cloneLives.className='clone-lives';
      cloneLives.textContent=`Vies: ${w.lives}`;

      clone.appendChild(cloneNumber);
      clone.appendChild(cloneLives);
      overlay.appendChild(clone);
    });
    overlay.style.display='flex';
  }
  function hideWinners(){
    const overlay=document.getElementById('winners-overlay');
    overlay.innerHTML='';
    overlay.style.display='none';

    const children=document.querySelectorAll('#players-container .player-card');
    children.forEach(cd=> cd.style.display='');
  }

  function showMinusLife(pid,val){
    const c= document.getElementById('players-container').children;
    let card=null;
    for(let cd of c){
      const numberDiv=cd.querySelector('.player-card-number');
      const cardId=parseInt(numberDiv.textContent);
      if(cardId===pid) {
        card=cd;
        break;
      }
    }
    if(!card)return;
    const rect=card.getBoundingClientRect();
    const minusEl=document.createElement('div');
    minusEl.className='minus-life';
    minusEl.textContent=`-${val}`;
    document.body.appendChild(minusEl);

    minusEl.style.left=(rect.left+rect.width/2)+'px';
    minusEl.style.top=rect.top+'px';

    minusEl.animate([
      {transform:'translate(-50%,0)',opacity:1},
      {transform:'translate(-50%,-50px)',opacity:0}
    ],{
      duration:1000,
      easing:'ease-out'
    }).onfinish=()=>{
      document.body.removeChild(minusEl);
    };
  }

  // ------------------------------------------------
  // Reconnaissance Vocale
  let recognition=null;
  let isVoiceActive=false;
  let isCommandMode=false;
  let interimMemory=new Set();

  function toggleVoiceRecognition(){
    if(!('webkitSpeechRecognition' in window)){
      console.error("La reconnaissance vocale n'est pas supportée.");
      return;
    }
    const voiceBtn=document.getElementById('voice-btn');
    if(!recognition){
      recognition=new webkitSpeechRecognition();
      recognition.lang='fr-FR';
      recognition.interimResults=true;
      recognition.maxAlternatives=1;
      recognition.continuous=true;

      recognition.onresult=(event)=>{
        for(let i=event.resultIndex;i<event.results.length;i++){
          const result=event.results[i];
          const transcript=result[0].transcript.toLowerCase().trim();

          if(!result.isFinal){
            // interim
            if(isCommandMode){
              detectNumbersOnTheFly(transcript);
            }
          } else {
            // final
            interimMemory.clear();
            if(transcript.includes('activer')) isCommandMode=true;
            if(transcript.includes('désactiver')) isCommandMode=false;
            if(isCommandMode) handleVoiceResult(transcript);
          }
        }
      };
      recognition.onerror=(err)=>console.error("Erreur vocale:",err);
      recognition.onend=()=>{
        if(isVoiceActive) recognition.start();
      };
    }
    if(!isVoiceActive){
      recognition.start();
      isVoiceActive=true;
      voiceBtn.textContent="Désactiver la Reconnaissance Vocale";
    } else {
      isVoiceActive=false;
      recognition.stop();
      voiceBtn.textContent="Activer la Reconnaissance Vocale";
    }
  }

  function detectNumbersOnTheFly(text){
    const digitMatches=text.match(/\d+/g);
    if(digitMatches){
      digitMatches.forEach(numStr=>{
        const numVal=parseInt(numStr,10);
        if(!interimMemory.has(numVal)){
          interimMemory.add(numVal);
          toggleWinnerInstant(numVal);
        }
      });
    }
  }

  const spelledNumbers={
    'un':1,'une':1,
    'deux':2,'de':2,
    'trois':3,'quatre':4,
    'cinq':5,'six':6,
    'sept':7,'huit':8,
    'neuf':9,'dix':10,
    'devis':2,'paires':2
  };

  function handleVoiceResult(result){
    console.log("Reco vocale (final):", result);

    // "retour"
    if(result.includes('retour')){
      undoAction();
      return;
    }
    // "retire moi tous les numéros"
    if(
      result.includes('retire moi tous les numéros') ||
      result.includes('retire-moi tous les numéros') ||
      result.includes('retiens-moi tous les numéros') ||
      result.includes('rupture moi tous les numéros')
    ){
      saveState();
      hideWinners();
      players.forEach(p=> p.isWinner=false);
      renderPlayers();
      return;
    }
    // "gagnant"
    if(result.includes('gagnant')){
      stopAudioFadeOut();
      playAudioFadeIn();
    }
    // "les autres perdront X"
    const perdrontMatch=result.match(/les autres perdront (\d+)/i);
    if(perdrontMatch){
      saveState();
      hideWinners();
      stopAudioFadeOut();
      const livesToRemove=parseInt(perdrontMatch[1],10);
      players.forEach(p=>{
        if(!p.isWinner && p.lives>0){
          p.lives-=livesToRemove;
          if(p.lives<0)p.lives=0;
          showMinusLife(p.id,livesToRemove);
        }
        p.isWinner=false;
      });
      renderPlayers();
      return;
    }
    // "les autres perdent X vies"
    if(result.includes('les autres perdent')){
      saveState();
      hideWinners();
      stopAudioFadeOut();
      const spelledRegex=/les autres perdent (un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i;
      const spelledMatch=result.match(spelledRegex);
      if(spelledMatch){
        let val= spelledMatch[1];
        if(spelledNumbers[val]!==undefined){
          val= spelledNumbers[val];
        } else {
          val= parseInt(val,10);
        }
        players.forEach(p=>{
          if(!p.isWinner && p.lives>0){
            p.lives-=val;
            if(p.lives<0)p.lives=0;
            showMinusLife(p.id,val);
          }
          p.isWinner=false;
        });
        renderPlayers();
      }
      return;
    }
    // "les autres paires de vie"/"les autres paires de devis"
    if(result.includes('les autres paires de vie')||result.includes('les autres paires de devis')){
      saveState();
      hideWinners();
      stopAudioFadeOut();
      const val=2;
      players.forEach(p=>{
        if(!p.isWinner && p.lives>0){
          p.lives-=val;
          if(p.lives<0)p.lives=0;
          showMinusLife(p.id,val);
        }
        p.isWinner=false;
      });
      renderPlayers();
      return;
    }
    // "tu peux me transférer X vies..."
    if(result.includes('tu peux me transférer')){
      saveState();
      hideWinners();
      const amountMatch=result.match(/(un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i);
      if(!amountMatch)return;
      let amountRaw= amountMatch[1].toLowerCase();
      let amountVal= spelledNumbers[amountRaw]!==undefined? spelledNumbers[amountRaw]: parseInt(amountRaw,10);

      const digits=result.match(/\d+/g);
      if(!digits||digits.length<2){
        console.warn("Pas assez de nombres pour détecter donneur / receveur");
        return;
      }
      const donorId=parseInt(digits[0],10);
      const receiverId=parseInt(digits[1],10);
      transferLives(donorId,receiverId,amountVal);
      return;
    }
    // Sinon "gagnant X Y Z"
    const matches=result.match(/\d+/g);
    if(matches){
      saveState();
      matches.forEach(num=>{
        const pid=parseInt(num,10);
        const pl=players.find(x=>x.id===pid);
        if(pl) pl.isWinner=true;
      });
      renderPlayers();
      showWinners();
    }
  }

  // ------------------------------------------------
  // Equipes + Décompte
  function createTeams(){
    const nb=prompt("Combien d'équipes ?","2");
    if(!nb||isNaN(nb)||nb<1)return;

    startCountdown(3, ()=>{
      distributionEquipes(parseInt(nb,10));
    });
  }

  // Décompte avec overlay et lecture de voix
  function startCountdown(from, callback) {
    const over = document.getElementById('countdown-overlay');
    const numEl = document.getElementById('countdown-number');
    over.style.display = 'flex';

    let val = from;
    numEl.textContent = val;

    // Fichier audio à chaque tick
    const countdownAudio = new Audio("https://ik.imagekit.io/lakolo/ElevenLabs_2025-03-15T14_23_41_SG_ivc_s89_sb82_se28_b_m2.mp3?updatedAt=1742048759828");
    countdownAudio.volume = 1;

    const timer = setInterval(()=>{
      val--;
      if(val>0){
        numEl.textContent= val;
        // Lecture de l'audio pour chaque décompte
        countdownAudio.currentTime=0;
        countdownAudio.play().catch(err=> console.warn("Audio error:", err));
      } else {
        clearInterval(timer);
        over.style.display='none';
        callback();
      }
    },1000);
  }

  function distributionEquipes(nbEquipes){
    // Shuffle
    let arr=[...players];
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]]=[arr[j], arr[i]];
    }
    // Round-robin
    let teams= Array.from({length:nbEquipes},()=>[]);
    let idx=0;
    arr.forEach(p=>{
      teams[idx].push(p);
      idx=(idx+1)%nbEquipes;
    });

    // On masque le players-container
    const pc=document.getElementById('players-container');
    pc.innerHTML='';
    pc.style.display='none';

    // On affiche le teams-container
    const tc=document.getElementById('teams-container');
    tc.innerHTML='';
    tc.style.display='flex';

    teams.forEach((teamArr,i)=>{
      const box=document.createElement('div');
      box.className='team-box';

      const title=document.createElement('h2');
      title.textContent= "Équipe "+(i+1);
      box.appendChild(title);

      const cardsDiv=document.createElement('div');
      cardsDiv.className='team-cards';

      teamArr.forEach(p=>{
        const card=document.createElement('div');
        card.className='player-card';
        if(p.lives<=0) card.classList.add('no-lives');
        if(p.isWinner) card.classList.add('active');

        const num=document.createElement('div');
        num.className='player-card-number';
        num.textContent= p.id.toString().padStart(3,'0');

        const lv=document.createElement('div');
        lv.className='player-lives';
        lv.textContent=`Vies: ${p.lives}`;

        card.appendChild(num);
        card.appendChild(lv);
        cardsDiv.appendChild(card);
      });

      box.appendChild(cardsDiv);
      tc.appendChild(box);
    });
  }

  function breakTeams(){
    // On supprime le contenu de #teams-container
    const tc=document.getElementById('teams-container');
    tc.innerHTML='';
    tc.style.display='none';

    // On ré-affiche le #players-container
    const pc=document.getElementById('players-container');
    pc.style.display='flex';

    // On rerender
    renderPlayers();
  }

  // ------------------------------------------------
  // Lancement initial
  renderPlayers();
</script>
</body>
</html>
