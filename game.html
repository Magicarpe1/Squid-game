<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Squid Game - Gestion des Joueurs</title>
  <style>
      @font-face {
          font-family: "GameOfSquids";
          src: url("https://ik.imagekit.io/lakolo/GameOfSquids-1GMVL.ttf");
      }
      @font-face {
          font-family: "PlayerFont";
          src: url("https://ik.imagekit.io/lakolo/JMH%20Beda.ttf");
      }

      body {
          font-family: "GameOfSquids", sans-serif;
          background-color: #101010;
          color: white;
          text-align: center;
          margin: 0;
          padding: 20px;
      }
      h1 {
          font-size: 3rem;
          margin: 20px 0;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          color: white;
      }
      h1 span {
          display: inline-block;
          font-family: "GameOfSquids", sans-serif;
          font-size: 3rem;
      }
      h1 span.shape-circle {
          color: #ff3e68;
      }
      h1 span.shape-triangle {
          color: #ff3e68;
      }
      h1 span.shape-square {
          color: #ff3e68;
          transform: scale(1.4);
          display: inline-block;
      }

      /* Conteneur principal */
      #players-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
      }

      .player-card {
          width: 80px;
          height: 120px;
          border: 2px solid white;
          border-radius: 5px;
          background-color: #007575;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          cursor: pointer;
          font-family: "PlayerFont", sans-serif;
          position: relative;
          transition: transform 0.2s;
      }
      .player-card:hover {
          transform: scale(1.05);
      }
      .player-card.active {
          border-color: limegreen;
          background-color: #0a0;
      }
      .player-card.no-lives {
          background-color: #505050 !important;
          opacity: 0.7;
      }

      .player-card-number {
          font-size: 2rem;
          color: white;
          background-color: #005050;
          padding: 5px 10px;
          border: 2px solid white;
          border-radius: 5px;
      }
      .player-lives {
          font-size: 1.6rem; 
          color: white;
          margin-top: 5px;
      }

      .buttons-container {
          margin-top: 400px;
      }
      button {
          padding: 10px 20px;
          font-size: 1.2rem;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 20px 10px;
          font-family: "GameOfSquids", sans-serif;
      }
      #submit-btn {
          background-color: #ff3e68;
          color: white;
      }
      #submit-btn:hover {
          background-color: #c32d4e;
      }
      #reset-btn {
          background-color: #32cd32;
          color: white;
      }
      #reset-btn:hover {
          background-color: #228b22;
      }
      #undo-btn {
          background-color: #888;
          color: white;
      }
      #undo-btn:hover {
          background-color: #555;
      }
      #voice-btn {
          background-color: #3f51b5;
          color: white;
      }
      #voice-btn:hover {
          background-color: #303f9f;
      }
      #teams-btn {
          background-color: #ffd700;
          color: black;
      }
      #teams-btn:hover {
          background-color: #ffca2c;
      }

      #lives-input {
          padding: 10px;
          font-size: 1.2rem;
          border-radius: 5px;
          border: 1px solid #fff;
          margin: 20px;
          background-color: #202020;
          color: #fff;
      }

      .heart-animation {
          position: absolute;
          font-size: 2rem;
          color: red;
          z-index: 9999;
          pointer-events: none;
          opacity: 1;
      }
      .minus-life {
          position: absolute;
          color: red;
          font-size: 1.5rem;
          font-weight: bold;
          opacity: 1;
          transform: translate(-50%, 0);
          pointer-events: none;
      }

      #winners-overlay {
          display: none;
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: rgba(0, 0, 0, 0.9);
          z-index: 99999;
          justify-content: center;
          align-items: center;
          flex-wrap: wrap;
          gap: 20px;
          padding: 20px;
      }
      .winner-clone {
          width: 140px; 
          height: 200px;
          margin: 10px;
          background-color: #007575;
          border: 3px solid #fff;
          border-radius: 5px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          animation: fadein 0.3s ease;
      }
      .winner-clone .clone-number {
          font-size: 3rem;
          background-color: #005050;
          color: #fff;
          border: 2px solid #fff;
          border-radius: 5px;
          padding: 5px 10px;
          margin: 5px;
      }
      .winner-clone .clone-lives {
          font-size: 1.5rem;
          color: #fff;
          margin-top: 5px;
      }
      @keyframes fadein {
          from { transform: scale(0.8); opacity: 0; }
          to   { transform: scale(1); opacity: 1; }
      }

      /* Overlay pour la roue */
      #wheel-overlay {
          display: none;
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.8);
          z-index: 999999;
          justify-content: center;
          align-items: center;
          flex-direction: column;
      }
      .wheel-container {
          position: relative;
          width: 400px;
          height: 400px;
          border-radius: 50%;
          overflow: hidden;
          border: 4px solid #fff;
      }
      /* Roue interne */
      #wheel {
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          transform: rotate(0deg);
          transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
      }
      .wheel-slice {
          position: absolute;
          width: 200px; /* la moitié du container */
          height: 200px;
          transform-origin: bottom right;
          background-color: #007575;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          border: 1px solid #101010;
          text-align: center;
          font-family: "PlayerFont", sans-serif;
          font-size: 0.9rem;
          padding: 10px;
          box-sizing: border-box;
      }
      .pointer {
          width: 0; 
          height: 0; 
          border-left: 25px solid transparent;
          border-right: 25px solid transparent;
          border-bottom: 30px solid #fff;
          margin-top: 20px;
      }
      .spin-btn {
          background-color: #ff4040;
          color: #fff;
      }
      .spin-btn:hover {
          background-color: #d03333;
      }
  </style>
</head>
<body>
  <h1>
      <span>SQUID</span>
      <span class="shape-circle">O</span>
      <span class="shape-triangle">Δ</span>
      <span class="shape-square">■</span>
      <span>GAME</span>
  </h1>
  <p>À qui le tour ?</p>

  <!-- Overlay gagnants -->
  <div id="winners-overlay"></div>

  <!-- Overlay roue -->
  <div id="wheel-overlay">
    <div class="pointer"></div>
    <div class="wheel-container">
      <div id="wheel"></div>
    </div>
    <button class="spin-btn" onclick="spinWheel()">Lancer la Roue</button>
  </div>

  <div id="players-container"></div>

  <div class="buttons-container">
      <input id="lives-input" type="number" placeholder="Vies à supprimer" min="1" />
      <button id="submit-btn" onclick="processRound()">Soumettre les gagnants</button>
      <button id="reset-btn" onclick="confirmReset()">Réinitialiser les vies</button>
      <button id="undo-btn" onclick="undoAction()">Retour</button>
      <button id="voice-btn" onclick="toggleVoiceRecognition()">Activer la Reconnaissance Vocale</button>

      <!-- Bouton pour créer des équipes -->
      <button id="teams-btn" onclick="createTeams()">Créer des équipes</button>
  </div>

  <script>
      // =============================
      // ====== LOGIQUE DE BASE ======
      // =============================

      // 0) Récupération du nombre de joueurs
      const urlParams = new URLSearchParams(window.location.search);
      const numPlayers = parseInt(urlParams.get('players'), 10) || 100;

      // On stocke : id, lives, isWinner, team
      let players = Array.from({ length: numPlayers }, (_, i) => ({
          id: i + 1,
          lives: 6,
          isWinner: false,
          team: null
      }));
      let lastPlayers = null; // snapshot

      function saveState() {
          lastPlayers = JSON.parse(JSON.stringify(players));
      }
      function undoAction() {
          if (!lastPlayers) {
              console.warn("Aucune action à annuler");
              return;
          }
          players = JSON.parse(JSON.stringify(lastPlayers));
          hideWinners();
          renderPlayers();
      }

      function renderPlayers() {
          const container = document.getElementById('players-container');
          container.innerHTML = '';
          players.forEach(p => {
              let cardClass = 'player-card';
              if (p.isWinner) cardClass += ' active';
              if (p.lives <= 0) cardClass += ' no-lives';

              const card = document.createElement('div');
              card.className = cardClass;
              card.onclick = () => toggleWinnerManually(p.id);

              const numDiv = document.createElement('div');
              numDiv.className = 'player-card-number';
              numDiv.textContent = p.id.toString().padStart(3, '0');

              const livesDiv = document.createElement('div');
              livesDiv.className = 'player-lives';
              livesDiv.textContent = `Vies: ${p.lives}`;

              card.appendChild(numDiv);
              card.appendChild(livesDiv);

              container.appendChild(card);
          });
      }
      function toggleWinnerManually(pid) {
          saveState();
          const pl = players.find(x => x.id === pid);
          if (!pl) return;
          pl.isWinner = !pl.isWinner;
          renderPlayers();
      }

      function toggleWinner(pid) {
          saveState();
          const pl = players.find(x => x.id === pid);
          if (!pl) return;
          pl.isWinner = !pl.isWinner;
          renderPlayers();
          showWinners();
      }
      function toggleWinnerInstant(pid) {
          saveState();
          const pl = players.find(x => x.id === pid);
          if (!pl) return;
          pl.isWinner = true;
          renderPlayers();
          showWinners();
      }

      function processRound() {
          saveState();
          hideWinners();
          const livesToRemove = parseInt(document.getElementById('lives-input').value) || 1;
          players.forEach(p => {
              if (!p.isWinner && p.lives > 0) {
                  p.lives -= livesToRemove;
                  if (p.lives < 0) p.lives = 0;
              }
              p.isWinner = false;
          });
          renderPlayers();
      }
      function confirmReset() {
          const sure = confirm("Êtes-vous sûr de vouloir réinitialiser ?");
          if (!sure) return;
          saveState();
          hideWinners();
          players.forEach(p => {
              p.lives = 6;
              p.isWinner = false;
              p.team = null;
          });
          renderPlayers();
      }

      // Overlay winners
      function showWinners() {
          const overlay = document.getElementById('winners-overlay');
          overlay.innerHTML = '';
          const winners = players.filter(x => x.isWinner);
          if (winners.length === 0) {
              overlay.style.display = 'none';
              return;
          }
          // On masque leur carte
          const cards = document.querySelectorAll('#players-container .player-card');
          cards.forEach(card => {
              const num = parseInt(card.querySelector('.player-card-number').textContent);
              const p = players.find(x => x.id === num);
              if (p && p.isWinner) {
                  card.style.display = 'none';
              }
          });
          // On ajoute un clone
          winners.forEach(w => {
              const clone = document.createElement('div');
              clone.className = 'winner-clone';
              clone.onclick = () => {
                  saveState();
                  w.isWinner = false;
                  hideWinners();
                  renderPlayers();
              };

              const numDiv = document.createElement('div');
              numDiv.className = 'clone-number';
              numDiv.textContent = w.id.toString().padStart(3,'0');

              const livesDiv = document.createElement('div');
              livesDiv.className = 'clone-lives';
              livesDiv.textContent = `Vies: ${w.lives}`;

              clone.appendChild(numDiv);
              clone.appendChild(livesDiv);
              overlay.appendChild(clone);
          });

          overlay.style.display = 'flex';
      }
      function hideWinners() {
          const overlay = document.getElementById('winners-overlay');
          overlay.innerHTML = '';
          overlay.style.display = 'none';
          // On réaffiche toutes les cartes
          const cards = document.querySelectorAll('#players-container .player-card');
          cards.forEach(c => c.style.display = '');
      }

      function showMinusLife(pid, lostVal) {
          const cards = document.querySelectorAll('#players-container .player-card');
          let target = null;
          cards.forEach(c => {
              const n = parseInt(c.querySelector('.player-card-number').textContent);
              if (n === pid) target = c;
          });
          if (!target) return;
          const rect = target.getBoundingClientRect();
          const minusEl = document.createElement('div');
          minusEl.className = 'minus-life';
          minusEl.textContent = `-${lostVal}`;
          document.body.appendChild(minusEl);

          minusEl.style.left = (rect.left + rect.width / 2) + 'px';
          minusEl.style.top = rect.top + 'px';

          minusEl.animate([
              { transform: 'translate(-50%, 0)', opacity: 1 },
              { transform: 'translate(-50%, -50px)', opacity: 0 }
          ], {
              duration: 1000,
              easing: 'ease-out'
          }).onfinish = () => {
              document.body.removeChild(minusEl);
          };
      }

      // ==============================
      // =========== TEAMS ============
      // ==============================
      let teamWheelSlices = [];
      let currentTeamsCount = 0;
      let currentTeamIndex = 0; // pour round-robin

      function createTeams() {
          const nb = prompt("Combien d'équipes ?", "4");
          if (!nb || isNaN(nb) || nb <= 0) return;
          currentTeamsCount = parseInt(nb,10);
          saveState();

          // On enlève toute team précédente
          players.forEach(p => p.team = null);

          // On prépare la liste de joueurs restants
          teamWheelSlices = [...players]; // shallow copy
          // On ouvre l'overlay
          openWheelOverlay();
          buildWheel(teamWheelSlices);
      }

      function openWheelOverlay() {
          document.getElementById('wheel-overlay').style.display = 'flex';
      }
      function closeWheelOverlay() {
          document.getElementById('wheel-overlay').style.display = 'none';
      }

      // Construit la roue HTML
      function buildWheel(sliceList) {
          const wheel = document.getElementById('wheel');
          wheel.innerHTML = '';

          if (sliceList.length === 0) {
              // plus personne => on ferme la roue
              closeWheelOverlay();
              renderPlayers();
              alert(`Répartition terminée avec ${currentTeamsCount} équipes !`);
              return;
          }

          // Pour chaque joueur => slice
          const sliceDeg = 360 / sliceList.length;
          sliceList.forEach((p, index) => {
              const slice = document.createElement('div');
              slice.className = 'wheel-slice';
              // angle
              const startAngle = index * sliceDeg;
              slice.style.transform = `rotate(${startAngle}deg) translate(-100%, 0)`; 
              
              // Couleur variable ?
              slice.style.backgroundColor = randomColor(index);
              slice.textContent = `#${p.id.toString().padStart(3,'0')}`;
              wheel.appendChild(slice);
          });
          // remise à 0 du style => for next spin
          wheel.style.transform = `rotate(0deg)`;
      }

      function randomColor(i) {
          // On peut faire un color pastel aléatoire, ou fixe
          const hue = (i * 42) % 360;
          return `hsl(${hue}, 70%, 50%)`;
      }

      function spinWheel() {
          const wheel = document.getElementById('wheel');
          if (!teamWheelSlices.length) return;

          // On choisit un angle random
          // ex. un random entre 360 * 5 et 360 * 8
          const rounds = 5 + Math.floor(Math.random()*4); 
          const randomSlice = Math.floor(Math.random() * teamWheelSlices.length);
          const sliceDeg = 360 / teamWheelSlices.length;
          // On veut s'arrêter centré sur la slice random
          const stopAngle = 360 - (randomSlice * sliceDeg) - (sliceDeg/2);
          const finalAngle = rounds*360 + stopAngle;

          wheel.style.transition = 'transform 4s cubic-bezier(0.33,1,0.68,1)';
          wheel.style.transform = `rotate(${finalAngle}deg)`;

          // On attend la fin de la transition
          setTimeout(() => {
              // On récupère p
              const p = teamWheelSlices[randomSlice];
              // On l'assigne à l'équipe
              assignToNextTeam(p);
              // On retire p du tableau
              teamWheelSlices.splice(randomSlice,1);
              // On reconstruit la roue
              buildWheel(teamWheelSlices);
          }, 4500);
      }

      function assignToNextTeam(player) {
          // Round Robin => on place player dans team = currentTeamIndex + 1
          const t = (currentTeamIndex % currentTeamsCount) + 1;
          currentTeamIndex++;
          player.team = t;
      }

      // Reconnaissance vocale (inchangé)
      let recognition = null;
      let isVoiceActive = false;
      let isCommandMode = false;
      let interimMemory = new Set();

      function toggleVoiceRecognition() {
          if (!('webkitSpeechRecognition' in window)) {
              console.error("La reconnaissance vocale n'est pas supportée.");
              return;
          }
          const voiceBtn = document.getElementById('voice-btn');
          if (!recognition) {
              recognition = new webkitSpeechRecognition();
              recognition.lang = 'fr-FR';
              recognition.interimResults = true;
              recognition.maxAlternatives = 1;
              recognition.continuous = true;

              recognition.onresult = (event) => {
                  for (let i = event.resultIndex; i < event.results.length; i++) {
                      const result = event.results[i];
                      const transcript = result[0].transcript.toLowerCase().trim();

                      if (!result.isFinal) {
                          if (isCommandMode) detectNumbersOnTheFly(transcript);
                      } else {
                          interimMemory.clear();
                          if (transcript.includes('activer')) {
                              isCommandMode = true;
                              console.log('Mode commande activé !');
                          }
                          if (transcript.includes('désactiver')) {
                              isCommandMode = false;
                              console.log('Mode commande désactivé !');
                          }
                          if (isCommandMode) {
                              handleVoiceResult(transcript);
                          }
                      }
                  }
              };

              recognition.onerror = (e) => console.error('Erreur vocale:', e.error);
              recognition.onend = () => {
                  if (isVoiceActive) recognition.start();
              };
          }
          if (!isVoiceActive) {
              recognition.start();
              isVoiceActive = true;
              voiceBtn.textContent = "Désactiver la Reconnaissance Vocale";
          } else {
              isVoiceActive = false;
              recognition.stop();
              voiceBtn.textContent = "Activer la Reconnaissance Vocale";
          }
      }

      function detectNumbersOnTheFly(txt) {
          const digits = txt.match(/\d+/g);
          if (digits) {
              digits.forEach(d => {
                  const numVal = parseInt(d,10);
                  if (!interimMemory.has(numVal)) {
                      interimMemory.add(numVal);
                      toggleWinnerInstant(numVal);
                  }
              });
          }
      }

      const spelledNumbers = {
          'un':1, 'une':1, 'deux':2, 'de':2, 'trois':3, 'quatre':4,
          'cinq':5, 'six':6, 'sept':7, 'huit':8, 'neuf':9, 'dix':10,
          'devis':2, 'paires':2
      };

      function handleVoiceResult(str) {
          console.log("Reco finale:", str);
          if (str.includes('retour')) {
              undoAction(); return;
          }
          if (str.includes('retire moi tous les numéros') ||
              str.includes('retire-moi tous les numéros') ||
              str.includes('retiens-moi tous les numéros') ||
              str.includes('rupture moi tous les numéros')) {
              saveState();
              hideWinners();
              players.forEach(p=> p.isWinner=false);
              renderPlayers();
              return;
          }
          if (str.includes('gagnant')) {
              stopAudioFadeOut();
              playAudioFadeIn();
          }
          const pm = str.match(/les autres perdront (\d+)/i);
          if (pm) {
              saveState();
              hideWinners();
              stopAudioFadeOut();
              const val = parseInt(pm[1],10);
              players.forEach(p=>{
                  if(!p.isWinner && p.lives>0){
                      p.lives-=val; if(p.lives<0)p.lives=0;
                      showMinusLife(p.id,val);
                  }
                  p.isWinner=false;
              });
              renderPlayers(); return;
          }
          if (str.includes('les autres perdent')) {
              saveState();
              hideWinners();
              stopAudioFadeOut();
              const spelledRegex = /les autres perdent (un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i;
              const m = str.match(spelledRegex);
              if(m){
                  let v = m[1];
                  if(spelledNumbers[v]!==undefined) v=spelledNumbers[v]; else v=parseInt(v,10);
                  players.forEach(p=>{
                      if(!p.isWinner && p.lives>0){
                          p.lives-=v; if(p.lives<0)p.lives=0;
                          showMinusLife(p.id,v);
                      }
                      p.isWinner=false;
                  });
                  renderPlayers();
              }
              return;
          }
          if(str.includes('les autres paires de vie')||str.includes('les autres paires de devis')){
              saveState(); hideWinners(); stopAudioFadeOut();
              const val=2;
              players.forEach(p=>{
                  if(!p.isWinner && p.lives>0){
                      p.lives-=val; if(p.lives<0)p.lives=0;
                      showMinusLife(p.id,val);
                  }
                  p.isWinner=false;
              });
              renderPlayers();return;
          }
          if(str.includes('tu peux me transférer')){
              saveState();hideWinners(); 
              const am = str.match(/(un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i);
              if(!am)return;
              let raw=am[1].toLowerCase();
              let val= spelledNumbers[raw]!==undefined? spelledNumbers[raw]: parseInt(raw,10);
              const digits=str.match(/\d+/g);
              if(!digits||digits.length<2)return;
              const donorId=parseInt(digits[0],10);
              const recvId=parseInt(digits[1],10);
              transferLives(donorId,recvId,val);
              return;
          }
          // "gagnant x y z"
          const matches = str.match(/\d+/g);
          if(matches){
              saveState();
              matches.forEach(d=>{
                  const n=parseInt(d,10);
                  const pl=players.find(x=>x.id===n);
                  if(pl) pl.isWinner=true;
              });
              renderPlayers();
              showWinners();
          }
      }

      // Au chargement
      renderPlayers();
  </script>
</body>
</html>
