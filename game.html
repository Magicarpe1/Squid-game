<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Squid Game - Gestion des Joueurs</title>
  <style>
    @font-face {
      font-family: "GameOfSquids";
      src: url("https://ik.imagekit.io/lakolo/GameOfSquids-1GMVL.ttf");
    }
    @font-face {
      font-family: "PlayerFont";
      src: url("https://ik.imagekit.io/lakolo/JMH%20Beda.ttf");
    }

    body {
      font-family: "GameOfSquids", sans-serif;
      background-color: #101010;
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 3rem;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      color: white;
    }
    h1 span {
      display: inline-block;
      font-family: "GameOfSquids", sans-serif;
      font-size: 3rem;
    }
    h1 span.shape-circle {
      color: #ff3e68;
    }
    h1 span.shape-triangle {
      color: #ff3e68;
    }
    h1 span.shape-square {
      color: #ff3e68;
      transform: scale(1.4);
      display: inline-block;
    }

    /* Container principal des joueurs */
    #players-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .player-card {
      width: 80px;
      height: 120px;
      border: 2px solid white;
      border-radius: 5px;
      background-color: #007575;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      cursor: pointer;
      font-family: "PlayerFont", sans-serif;
      position: relative;
    }
    .player-card.active {
      border-color: limegreen;
      background-color: #0a0;
    }
    .player-card.no-lives {
      background-color: #505050 !important;
      opacity: 0.7;
    }

    .player-card-number {
      font-size: 2rem;
      color: white;
      background-color: #005050;
      padding: 5px 10px;
      border: 2px solid white;
      border-radius: 5px;
    }
    .player-lives {
      font-size: 1.6rem;
      color: white;
      margin-top: 5px;
    }

    /* Boutons en bas */
    .buttons-container {
      margin-top: 400px;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 20px 10px;
      font-family: "GameOfSquids", sans-serif;
    }
    #submit-btn {
      background-color: #ff3e68;
      color: white;
    }
    #submit-btn:hover {
      background-color: #c32d4e;
    }
    #reset-btn {
      background-color: #32cd32;
      color: white;
    }
    #reset-btn:hover {
      background-color: #228b22;
    }
    #undo-btn {
      background-color: #888;
      color: white;
    }
    #undo-btn:hover {
      background-color: #555;
    }
    #voice-btn {
      background-color: #3f51b5;
      color: white;
    }
    #voice-btn:hover {
      background-color: #303f9f;
    }
    #teams-btn {
      background-color: #ffcc00;
      color: #000;
    }
    #teams-btn:hover {
      background-color: #e6b800;
    }
    /* Bouton "break teams" */
    #break-teams-btn {
      background-color: #777;
      color: white;
    }
    #break-teams-btn:hover {
      background-color: #555;
    }

    #lives-input {
      padding: 10px;
      font-size: 1.2rem;
      border-radius: 5px;
      border: 1px solid #fff;
      margin: 20px;
      background-color: #202020;
      color: #fff;
    }

    /* Animation - vie */
    .minus-life {
      position: absolute;
      color: red;
      font-size: 1.5rem;
      font-weight: bold;
      opacity: 1;
      transform: translate(-50%, 0);
      pointer-events: none;
    }

    /* Overlay pour les gagnants */
    #winners-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.9);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }
    .winner-clone {
      width: 140px;
      height: 200px;
      margin: 10px;
      background-color: #007575;
      border: 3px solid #fff;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadein 0.3s ease;
    }
    .winner-clone .clone-number {
      font-size: 3rem;
      background-color: #005050;
      color: #fff;
      border: 2px solid #fff;
      border-radius: 5px;
      padding: 5px 10px;
      margin: 5px;
    }
    .winner-clone .clone-lives {
      font-size: 1.5rem;
      color: #fff;
      margin-top: 5px;
    }
    @keyframes fadein {
      from { transform: scale(0.8); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    /* Overlay pour le décompte */
    #countdown-overlay {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background-color: rgba(0,0,0,0.8);
      z-index: 999999;
      justify-content: center;
      align-items: center;
    }
    #countdown-number {
      font-size: 8rem;
      color: #ff3e68;
      font-family: "GameOfSquids", sans-serif;
    }

    /* Conteneur des équipes => flex horizontal (pas de scroll vertical si possible) */
    #teams-container {
      display: none; /* on le cachera tant que pas créé */
      margin-top: 30px;
      display: flex;
      justify-content: center; /* centre horizontalement */
      gap: 30px;
      flex-wrap: nowrap; /* si y a trop d’équipes, ça risque de dépasser l'écran */
      overflow-x: auto; /* si c’est trop, on aura un scroll horizontal */
    }
    .team-box {
      border: 2px dashed #aaa;
      border-radius: 5px;
      padding: 10px;
      min-width: 200px;
    }
    .team-box h2 {
      font-family: "GameOfSquids", sans-serif;
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #ffcc00;
    }
    .team-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
<h1>
  <span>SQUID</span>
  <span class="shape-circle">O</span>
  <span class="shape-triangle">Δ</span>
  <span class="shape-square">■</span>
  <span>GAME</span>
</h1>
<p>À qui le tour ?</p>

<!-- Overlay gagnants -->
<div id="winners-overlay"></div>

<!-- Overlay décompte -->
<div id="countdown-overlay">
  <div id="countdown-number">3</div>
</div>

<!-- Container principal (joueurs) -->
<div id="players-container"></div>

<!-- Container final (équipes) -->
<div id="teams-container"></div>

<div class="buttons-container">
  <input id="lives-input" type="number" placeholder="Vies à supprimer" min="1" />
  <button id="submit-btn" onclick="processRound()">Soumettre les gagnants</button>
  <button id="reset-btn" onclick="confirmReset()">Réinitialiser les vies</button>
  <button id="undo-btn" onclick="undoAction()">Retour</button>
  <button id="voice-btn" onclick="toggleVoiceRecognition()">Activer la Reconnaissance Vocale</button>

  <!-- Bouton créer Equipes -->
  <button id="teams-btn" onclick="createTeams()">Créer les équipes</button>

  <!-- Bouton casser Equipes -->
  <button id="break-teams-btn" onclick="breakTeams()">Casser les équipes</button>
</div>

<script>
  // Param
  const urlParams = new URLSearchParams(window.location.search);
  const numPlayers = parseInt(urlParams.get('players'), 10) || 12;
  let players = Array.from({ length: numPlayers }, (_, i)=>({
    id: i+1,
    lives: 6,
    isWinner: false
  }));
  let lastPlayers=null;

  function saveState(){
    lastPlayers= JSON.parse(JSON.stringify(players));
  }
  function undoAction(){
    if(!lastPlayers) return;
    players= JSON.parse(JSON.stringify(lastPlayers));
    hideWinners();
    renderPlayers();
  }

  // ---------- RENDER ----------
  function renderPlayers(){
    const cont=document.getElementById('players-container');
    cont.innerHTML='';
    cont.style.display='flex'; // on ré-affiche si besoin
    players.forEach(p=>{
      let cardClass='player-card';
      if(p.isWinner) cardClass+=' active';
      if(p.lives<=0) cardClass+=' no-lives';

      const card=document.createElement('div');
      card.className=cardClass;
      card.onclick=()=>toggleWinnerManually(p.id);

      const pn=document.createElement('div');
      pn.className='player-card-number';
      pn.textContent=p.id.toString().padStart(3,'0');

      const lv=document.createElement('div');
      lv.className='player-lives';
      lv.textContent=`Vies: ${p.lives}`;

      card.appendChild(pn);
      card.appendChild(lv);
      cont.appendChild(card);
    });
  }
  function toggleWinnerManually(pid){
    saveState();
    const pl=players.find(x=>x.id===pid);
    if(!pl)return;
    pl.isWinner=!pl.isWinner;
    renderPlayers();
  }
  function toggleWinner(pid){
    saveState();
    const pl= players.find(x=>x.id===pid);
    if(!pl)return;
    pl.isWinner=!pl.isWinner;
    renderPlayers();
    showWinners();
  }
  function toggleWinnerInstant(pid){
    saveState();
    const pl= players.find(x=>x.id===pid);
    if(!pl)return;
    pl.isWinner=true;
    renderPlayers();
    showWinners();
  }

  // ---------- ROUND ----------
  function processRound(){
    saveState();
    hideWinners();
    const val= parseInt(document.getElementById('lives-input').value)||1;
    players.forEach(p=>{
      if(!p.isWinner && p.lives>0){
        p.lives-=val;
        if(p.lives<0)p.lives=0;
      }
      p.isWinner=false;
    });
    renderPlayers();
  }
  function confirmReset(){
    const sure=confirm("Êtes-vous sûr ?");
    if(!sure)return;
    saveState();
    hideWinners();
    players.forEach(p=>{
      p.lives=6; p.isWinner=false;
    });
    renderPlayers();
  }

  // ---------- WINNERS OVERLAY ----------
  function showWinners(){
    const w= players.filter(x=>x.isWinner);
    const ov= document.getElementById('winners-overlay');
    ov.innerHTML='';
    if(!w.length){
      ov.style.display='none';
      return;
    }
    // masquage
    const c= document.querySelectorAll('#players-container .player-card');
    c.forEach(cd=>{
      const idNum= parseInt(cd.querySelector('.player-card-number').textContent);
      if(w.some(ww=>ww.id===idNum)) cd.style.display='none';
    });
    w.forEach(wi=>{
      const clone= document.createElement('div');
      clone.className='winner-clone';
      clone.onclick=()=>{
        saveState();
        wi.isWinner=false;
        hideWinners();
        renderPlayers();
      };
      const cn=document.createElement('div');
      cn.className='clone-number';
      cn.textContent= wi.id.toString().padStart(3,'0');

      const cl=document.createElement('div');
      cl.className='clone-lives';
      cl.textContent=`Vies: ${wi.lives}`;

      clone.appendChild(cn);
      clone.appendChild(cl);
      ov.appendChild(clone);
    });
    ov.style.display='flex';
  }
  function hideWinners(){
    const ov= document.getElementById('winners-overlay');
    ov.innerHTML='';
    ov.style.display='none';

    const c= document.querySelectorAll('#players-container .player-card');
    c.forEach(cd=> cd.style.display='');
  }

  function showMinusLife(pid, val){
    const c= document.getElementById('players-container').children;
    let cardEl=null;
    for(let cd of c){
      const idNum= parseInt(cd.querySelector('.player-card-number').textContent);
      if(idNum===pid) cardEl=cd;
    }
    if(!cardEl)return;
    const rect=cardEl.getBoundingClientRect();
    const minusEl=document.createElement('div');
    minusEl.className='minus-life';
    minusEl.textContent=`-${val}`;
    document.body.appendChild(minusEl);

    minusEl.style.left= (rect.left+rect.width/2)+'px';
    minusEl.style.top= rect.top+'px';
    minusEl.animate([
      {transform:'translate(-50%,0)', opacity:1},
      {transform:'translate(-50%,-50px)', opacity:0}
    ],{
      duration:1000,
      easing:'ease-out'
    }).onfinish=()=>{
      document.body.removeChild(minusEl);
    };
  }

  // ---------- VOICE RECO ----------
  let recognition=null;
  let isVoiceActive=false;
  let isCommandMode=false;
  let interimMemory=new Set();

  function toggleVoiceRecognition(){
    if(!('webkitSpeechRecognition' in window)){
      console.error("Pas supporté");
      return;
    }
    const vb= document.getElementById('voice-btn');
    if(!recognition){
      recognition= new webkitSpeechRecognition();
      recognition.lang='fr-FR';
      recognition.interimResults=true;
      recognition.maxAlternatives=1;
      recognition.continuous=true;

      recognition.onresult=(e)=>{
        for(let i=e.resultIndex; i< e.results.length; i++){
          const r=e.results[i];
          const txt=r[0].transcript.toLowerCase().trim();
          if(!r.isFinal){
            if(isCommandMode) detectNumbersOnTheFly(txt);
          } else {
            interimMemory.clear();
            if(txt.includes('activer')) isCommandMode=true;
            if(txt.includes('désactiver')) isCommandMode=false;
            if(isCommandMode) handleVoiceResult(txt);
          }
        }
      };
      recognition.onerror=(err)=> console.error(err);
      recognition.onend=()=>{
        if(isVoiceActive) recognition.start();
      };
    }
    if(!isVoiceActive){
      recognition.start();
      isVoiceActive=true;
      vb.textContent="Désactiver la Reconnaissance Vocale";
    } else {
      isVoiceActive=false;
      recognition.stop();
      vb.textContent="Activer la Reconnaissance Vocale";
    }
  }
  function detectNumbersOnTheFly(txt){
    const m= txt.match(/\d+/g);
    if(m){
      m.forEach(mm=>{
        const val= parseInt(mm,10);
        if(!interimMemory.has(val)){
          interimMemory.add(val);
          toggleWinnerInstant(val);
        }
      });
    }
  }
  const spelledNumbers={
    'un':1, 'une':1,
    'deux':2,'de':2,
    'trois':3,'quatre':4,
    'cinq':5,'six':6,
    'sept':7,'huit':8,
    'neuf':9,'dix':10,
    'devis':2,'paires':2
  };
  function handleVoiceResult(str){
    console.log("Reco final:", str);
    // ... (mêmes commandes existantes : retire moi tous les numéros, etc.)
  }

  // =============== TEAMS + COMPTE À REBOURS ===============
  function createTeams(){
    const nb= prompt("Combien d'équipes ?", "2");
    if(!nb||isNaN(nb)||nb<1)return;

    startCountdown(3, ()=>{
      distributionEquipes(parseInt(nb,10));
    });
  }

  function startCountdown(from, callback){
    const over= document.getElementById('countdown-overlay');
    const numEl= document.getElementById('countdown-number');
    over.style.display='flex';

    let val= from;
    numEl.textContent= val;
    const timer= setInterval(()=>{
      val--;
      if(val<=0){
        clearInterval(timer);
        over.style.display='none';
        callback();
      } else {
        numEl.textContent= val;
      }
    }, 1000);
  }

  function distributionEquipes(nbEquipes){
    // Shuffle
    let arr=[...players];
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]]= [arr[j], arr[i]];
    }
    // Round robin
    let teams= Array.from({length:nbEquipes},()=>[]);
    let idx=0;
    arr.forEach(p=>{
      teams[idx].push(p);
      idx=(idx+1)%nbEquipes;
    });

    // masque players
    const pc= document.getElementById('players-container');
    pc.innerHTML='';
    pc.style.display='none';

    // affiche teams
    const tc= document.getElementById('teams-container');
    tc.innerHTML='';
    tc.style.display='flex';

    teams.forEach((teamArr, i)=>{
      const box= document.createElement('div');
      box.className='team-box';

      const title= document.createElement('h2');
      title.textContent= "Équipe "+(i+1);
      box.appendChild(title);

      const cardsDiv= document.createElement('div');
      cardsDiv.className='team-cards';

      teamArr.forEach(p=>{
        const card= document.createElement('div');
        card.className='player-card';
        if(p.lives<=0) card.classList.add('no-lives');
        if(p.isWinner) card.classList.add('active');

        const num= document.createElement('div');
        num.className='player-card-number';
        num.textContent= p.id.toString().padStart(3,'0');

        const lv= document.createElement('div');
        lv.className='player-lives';
        lv.textContent= `Vies: ${p.lives}`;

        card.appendChild(num);
        card.appendChild(lv);
        cardsDiv.appendChild(card);
      });

      box.appendChild(cardsDiv);
      tc.appendChild(box);
    });
  }

  // ---- NOUVELLE FONCTION : CASSER LES ÉQUIPES ----
  function breakTeams(){
    // on supprime le contenu des teams
    const tc= document.getElementById('teams-container');
    tc.innerHTML='';
    tc.style.display='none';

    // on ré-affiche la grille de joueurs
    const pc= document.getElementById('players-container');
    pc.style.display='flex';

    // on re-rend
    renderPlayers();
  }

  // Start
  renderPlayers();
</script>
</body>
</html>
