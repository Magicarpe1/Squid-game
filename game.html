<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Squid Game - Gestion des Joueurs</title>
  <style>
      @font-face {
          font-family: "GameOfSquids";
          src: url("https://ik.imagekit.io/lakolo/GameOfSquids-1GMVL.ttf");
      }
      @font-face {
          font-family: "PlayerFont";
          src: url("https://ik.imagekit.io/lakolo/JMH%20Beda.ttf");
      }

      body {
          font-family: "GameOfSquids", sans-serif;
          background-color: #101010;
          color: white;
          text-align: center;
          margin: 0;
          padding: 20px;
      }
      h1 {
          font-size: 3rem;
          margin: 20px 0;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          color: white;
      }
      h1 span {
          display: inline-block;
          font-family: "GameOfSquids", sans-serif;
          font-size: 3rem;
      }
      h1 span.shape-circle {
          color: #ff3e68;
      }
      h1 span.shape-triangle {
          color: #ff3e68;
      }
      h1 span.shape-square {
          color: #ff3e68;
          transform: scale(1.4);
          display: inline-block;
      }

      /* Conteneur principal */
      #players-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
      }

      .player-card {
          width: 80px;
          height: 120px;
          border: 2px solid white;
          border-radius: 5px;
          background-color: #007575;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          cursor: pointer;
          font-family: "PlayerFont", sans-serif;
          position: relative;
          transition: transform 0.2s;
      }
      .player-card:hover {
          transform: scale(1.05);
      }
      .player-card.active {
          border-color: limegreen;
          background-color: #0a0;
      }
      .player-card.no-lives {
          background-color: #505050 !important;
          opacity: 0.7;
      }
      .player-card-number {
          font-size: 2rem;
          color: white;
          background-color: #005050;
          padding: 5px 10px;
          border: 2px solid white;
          border-radius: 5px;
      }
      .player-lives {
          font-size: 1.6rem;
          color: white;
          margin-top: 5px;
      }

      /* Boutons en bas */
      .buttons-container {
          margin-top: 400px;
      }
      button {
          padding: 10px 20px;
          font-size: 1.2rem;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 20px 10px;
          font-family: "GameOfSquids", sans-serif;
      }
      #submit-btn {
          background-color: #ff3e68;
          color: white;
      }
      #submit-btn:hover {
          background-color: #c32d4e;
      }
      #reset-btn {
          background-color: #32cd32;
          color: white;
      }
      #reset-btn:hover {
          background-color: #228b22;
      }
      #undo-btn {
          background-color: #888;
          color: white;
      }
      #undo-btn:hover {
          background-color: #555;
      }
      #voice-btn {
          background-color: #3f51b5;
          color: white;
      }
      #voice-btn:hover {
          background-color: #303f9f;
      }
      #teams-btn {
          background-color: #ffcc00;
          color: #000;
      }
      #teams-btn:hover {
          background-color: #e6b800;
      }
      #lives-input {
          padding: 10px;
          font-size: 1.2rem;
          border-radius: 5px;
          border: 1px solid #fff;
          margin: 20px;
          background-color: #202020;
          color: #fff;
      }

      /* Animation du coeur / la vie en moins */
      .minus-life {
          position: absolute;
          color: red;
          font-size: 1.5rem;
          font-weight: bold;
          opacity: 1;
          transform: translate(-50%, 0);
          pointer-events: none;
      }

      /* Overlay winners */
      #winners-overlay {
          display: none;
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: rgba(0, 0, 0, 0.9);
          z-index: 99999;
          justify-content: center;
          align-items: center;
          flex-wrap: wrap;
          gap: 20px;
          padding: 20px;
      }
      .winner-clone {
          width: 140px; 
          height: 200px;
          margin: 10px;
          background-color: #007575;
          border: 3px solid #fff;
          border-radius: 5px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          animation: fadein 0.3s ease;
      }
      .winner-clone .clone-number {
          font-size: 3rem;
          background-color: #005050;
          color: #fff;
          border: 2px solid #fff;
          border-radius: 5px;
          padding: 5px 10px;
          margin: 5px;
      }
      .winner-clone .clone-lives {
          font-size: 1.5rem;
          color: #fff;
          margin-top: 5px;
      }
      @keyframes fadein {
          from { transform: scale(0.8); opacity: 0; }
          to   { transform: scale(1); opacity: 1; }
      }

      /* Boule 3D */
      .transform-to-ball {
          position: absolute;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: linear-gradient(145deg, #008080, #005050);
          box-shadow: 0 0 12px #00cccc;
          color: white;
          font-family: "PlayerFont", sans-serif;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 1;
          animation: none;
      }
      /* Animation swirl (rotation) */
      /* On va animer leur position autour d'un centre (logic) => via JS */

      /* Conteneur final */
      #teams-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 40px;
          margin-top: 50px;
      }
      .team-box {
          border: 2px dashed #ccc;
          padding: 20px;
          min-width: 120px;
          border-radius: 10px;
      }
      .team-box h2 {
          font-family: "GameOfSquids", sans-serif;
          font-size: 1.5rem;
          margin-bottom: 10px;
      }
  </style>
</head>
<body>
  <h1>
      <span>SQUID</span>
      <span class="shape-circle">O</span>
      <span class="shape-triangle">Δ</span>
      <span class="shape-square">■</span>
      <span>GAME</span>
  </h1>
  <p>À qui le tour ?</p>

  <!-- Overlay winners -->
  <div id="winners-overlay"></div>

  <!-- Main players container -->
  <div id="players-container"></div>

  <div class="buttons-container">
      <input id="lives-input" type="number" placeholder="Vies à supprimer" min="1" />
      <button id="submit-btn" onclick="processRound()">Soumettre les gagnants</button>
      <button id="reset-btn" onclick="confirmReset()">Réinitialiser les vies</button>
      <button id="undo-btn" onclick="undoAction()">Retour</button>
      <button id="voice-btn" onclick="toggleVoiceRecognition()">Activer la Reconnaissance Vocale</button>
      <button id="teams-btn" onclick="createTeams()">Créer des équipes</button>
  </div>

  <div id="teams-container"></div>

  <script>
      // 0) Param
      const urlParams = new URLSearchParams(window.location.search);
      const numPlayers = parseInt(urlParams.get('players'), 10) || 12;

      // 1) Data
      let players = Array.from({ length: numPlayers }, (_, i) => ({
          id: i + 1,
          lives: 6,
          isWinner: false
      }));
      let lastPlayers = null;

      function saveState() {
          lastPlayers = JSON.parse(JSON.stringify(players));
      }
      function undoAction() {
          if (!lastPlayers) return;
          players = JSON.parse(JSON.stringify(lastPlayers));
          hideWinners();
          renderPlayers();
      }

      // 2) Rendu
      function renderPlayers() {
          const container = document.getElementById('players-container');
          container.innerHTML = '';
          players.forEach(p=>{
              let c = 'player-card';
              if(p.isWinner) c+=' active';
              if(p.lives<=0) c+=' no-lives';

              const card = document.createElement('div');
              card.className=c;
              card.onclick=()=>toggleWinnerManually(p.id);

              const num = document.createElement('div');
              num.className='player-card-number';
              num.textContent= p.id.toString().padStart(3,'0');

              const lv = document.createElement('div');
              lv.className='player-lives';
              lv.textContent=`Vies: ${p.lives}`;

              card.appendChild(num);
              card.appendChild(lv);
              container.appendChild(card);
          });
      }

      function toggleWinnerManually(pid){
          saveState();
          const pl=players.find(x=>x.id===pid);
          if(!pl)return;
          pl.isWinner=!pl.isWinner;
          renderPlayers();
      }
      function toggleWinner(pid){
          saveState();
          const pl=players.find(x=>x.id===pid);
          if(!pl)return;
          pl.isWinner=!pl.isWinner;
          renderPlayers();
          showWinners();
      }
      function toggleWinnerInstant(pid){
          saveState();
          const pl=players.find(x=>x.id===pid);
          if(!pl)return;
          pl.isWinner=true;
          renderPlayers();
          showWinners();
      }

      // 3) Rounds
      function processRound(){
          saveState();
          hideWinners();
          const val=parseInt(document.getElementById('lives-input').value)||1;
          players.forEach(p=>{
              if(!p.isWinner && p.lives>0){
                  p.lives-=val;
                  if(p.lives<0)p.lives=0;
              }
              p.isWinner=false;
          });
          renderPlayers();
      }
      function confirmReset(){
          const sure=confirm("Êtes-vous sûr ?");
          if(!sure)return;
          saveState();
          hideWinners();
          players.forEach(p=>{
              p.lives=6; p.isWinner=false;
          });
          renderPlayers();
      }

      // 4) Winners overlay
      function showWinners(){
          const winners=players.filter(x=>x.isWinner);
          const ov=document.getElementById('winners-overlay');
          ov.innerHTML='';
          if(!winners.length){
              ov.style.display='none';
              return;
          }
          // masque
          const cards=document.querySelectorAll('#players-container .player-card');
          cards.forEach(cd=>{
              const n= parseInt(cd.querySelector('.player-card-number').textContent);
              if(winners.some(w=>w.id===n)){
                  cd.style.display='none';
              }
          });
          winners.forEach(w=>{
              const c=document.createElement('div');
              c.className='winner-clone';
              c.onclick=()=>{
                  saveState();
                  w.isWinner=false;
                  hideWinners();
                  renderPlayers();
              };
              const cn=document.createElement('div');
              cn.className='clone-number';
              cn.textContent= w.id.toString().padStart(3,'0');

              const cl=document.createElement('div');
              cl.className='clone-lives';
              cl.textContent=`Vies: ${w.lives}`;

              c.appendChild(cn);
              c.appendChild(cl);
              ov.appendChild(c);
          });
          ov.style.display='flex';
      }
      function hideWinners(){
          const ov=document.getElementById('winners-overlay');
          ov.innerHTML='';
          ov.style.display='none';

          const cards=document.querySelectorAll('#players-container .player-card');
          cards.forEach(cd=> cd.style.display='');
      }

      // - / showMinusLife
      function showMinusLife(pid, val){
          const container=document.querySelectorAll('#players-container .player-card');
          let cardEl=null;
          container.forEach(c=>{
              const num= parseInt(c.querySelector('.player-card-number').textContent);
              if(num===pid) cardEl=c;
          });
          if(!cardEl)return;
          const rect=cardEl.getBoundingClientRect();
          const minusEl=document.createElement('div');
          minusEl.className='minus-life';
          minusEl.textContent=`-${val}`;
          document.body.appendChild(minusEl);

          minusEl.style.left=(rect.left+rect.width/2)+'px';
          minusEl.style.top=rect.top+'px';
          minusEl.animate([
              {transform:'translate(-50%,0)',opacity:1},
              {transform:'translate(-50%,-50px)',opacity:0}
          ],{
              duration:1000,
              easing:'ease-out'
          }).onfinish=()=>{
              document.body.removeChild(minusEl);
          }
      }

      // 5) Reconnaissance vocale (inchangé)
      let recognition=null;
      let isVoiceActive=false;
      let isCommandMode=false;
      let interimMemory=new Set();

      function toggleVoiceRecognition(){
          if(!('webkitSpeechRecognition' in window)){
              console.error("Pas de reco vocale");
              return;
          }
          const voiceBtn=document.getElementById('voice-btn');
          if(!recognition){
              recognition=new webkitSpeechRecognition();
              recognition.lang='fr-FR';
              recognition.interimResults=true;
              recognition.maxAlternatives=1;
              recognition.continuous=true;

              recognition.onresult=(e)=>{
                  for(let i=e.resultIndex;i< e.results.length;i++){
                      const r=e.results[i];
                      const txt=r[0].transcript.toLowerCase().trim();
                      if(!r.isFinal){
                          if(isCommandMode) detectNumbersOnTheFly(txt);
                      } else {
                          interimMemory.clear();
                          if(txt.includes('activer')){
                              isCommandMode=true;
                              console.log("Cmd ON");
                          }
                          if(txt.includes('désactiver')){
                              isCommandMode=false;
                              console.log("Cmd OFF");
                          }
                          if(isCommandMode) handleVoiceResult(txt);
                      }
                  }
              };
              recognition.onerror=(er)=> console.error(er);
              recognition.onend=()=>{
                  if(isVoiceActive) recognition.start();
              };
          }
          if(!isVoiceActive){
              recognition.start();
              isVoiceActive=true;
              voiceBtn.textContent="Désactiver la Reconnaissance Vocale";
          } else {
              isVoiceActive=false;
              recognition.stop();
              voiceBtn.textContent="Activer la Reconnaissance Vocale";
          }
      }
      function detectNumbersOnTheFly(txt){
          const m=txt.match(/\d+/g);
          if(m){
              m.forEach(mm=>{
                  const val=parseInt(mm,10);
                  if(!interimMemory.has(val)){
                      interimMemory.add(val);
                      toggleWinnerInstant(val);
                  }
              });
          }
      }
      const spelledNumbers={
          'un':1,'une':1,
          'deux':2,'de':2,
          'trois':3,'quatre':4,
          'cinq':5,'six':6,
          'sept':7,'huit':8,
          'neuf':9,'dix':10,
          'devis':2,'paires':2
      };
      function handleVoiceResult(str){
          console.log("Reco final:",str);
          // ...
          // Cf. ton code existant gérant "retour", "gagnant", "les autres perdent", etc.
      }

      // ============== 6) Création d'équipes ==============
      function createTeams(){
          const nbEquipes = prompt("Combien d'équipes ?", "2");
          if(!nbEquipes || isNaN(nbEquipes)||nbEquipes<=0) return;

          // Shuffle players
          let arr=[...players];
          for(let i=arr.length-1; i>0; i--){
              const j=Math.floor(Math.random()*(i+1));
              [arr[i], arr[j]]=[arr[j], arr[i]];
          }
          // Répartition
          let teams= Array.from({length:nbEquipes}, ()=>[]);
          let idx=0;
          arr.forEach(p=>{
              teams[idx].push(p);
              idx=(idx+1)%nbEquipes;
          });

          // 1) On transforme "cartes" en boules absolues
          const container=document.getElementById('players-container');
          const cards= container.querySelectorAll('.player-card');
          cards.forEach(card=>{
              // on calcule la position
              const rect=card.getBoundingClientRect();
              // on passe en absolu
              card.style.position='absolute';
              card.style.left= rect.left+'px';
              card.style.top= rect.top+'px';
              card.style.width= rect.width+'px';
              card.style.height= rect.height+'px';
          });

          // Petit reflow
          setTimeout(()=>{
              // On convertit en boule + stock
              cards.forEach(card=>{
                  card.classList.remove('player-card');
                  card.classList.add('transform-to-ball');
                  // On met le text du playerId en direct
                  const idTxt= card.querySelector('.player-card-number').textContent;
                  card.innerHTML= idTxt;
              });
          },100);

          // 2) Faire "tourner" (mélanger) ces boules
          //    => On va leur attribuer un mouvement circulaire random ~2s
          swirlMix(cards);

          // 3) Après le swirl (2s), on place dans teams => #teams-container
          setTimeout(()=>{
              container.innerHTML="";
              document.getElementById('teams-container').innerHTML="";
              // On affiche
              teams.forEach((teamArr, i)=>{
                  const box=document.createElement('div');
                  box.className='team-box';
                  const h2=document.createElement('h2');
                  h2.textContent=`Équipe ${i+1}`;
                  box.appendChild(h2);

                  teamArr.forEach(p=>{
                      // on cree un .transform-to-ball final
                      const b=document.createElement('div');
                      b.className='transform-to-ball';
                      b.style.animation='none';
                      b.style.width='50px';
                      b.style.height='50px';
                      b.textContent= p.id.toString().padStart(3,'0');
                      box.appendChild(b);
                  });
                  document.getElementById('teams-container').appendChild(box);
              });
          }, 2100);
      }

      // swirlMix: on anime les boules pour 2s sur un cercle autour du centre
      function swirlMix(cards) {
          const centerX= window.innerWidth/2;
          const centerY= window.innerHeight/2 - 100;
          const radius= 150;
          // on calcule la position initiale => on anime via a Keyframe or direct setInterval
          // Pour la démo, on fait un setInterval => 60 fps
          let t=0;
          const dur=2000; // 2s
          const fps=60;
          const step= dur/fps;
          // On associe un angle distinct pour chaque boule
          let angles=[];
          cards.forEach((_,i)=> angles.push(Math.random()*360));
          let timer=setInterval(()=>{
              t+=step;
              if(t>=dur) {
                  clearInterval(timer);
                  return;
              }
              // fraction
              let fraction=t/dur; // 0->1
              // on fait un swirl complet => +360 * fraction
              cards.forEach((card,i)=>{
                  let baseAngle= angles[i];
                  let swirlAngle= baseAngle + 360*fraction;
                  let rad= swirlAngle * Math.PI/180;
                  let x= centerX + radius * Math.cos(rad);
                  let y= centerY + radius * Math.sin(rad);
                  card.style.left= (x-30)+'px'; // center the 60px
                  card.style.top= (y-30)+'px';
              });
          }, step);
      }

      // On start
      renderPlayers();
  </script>
</body>
</html>

