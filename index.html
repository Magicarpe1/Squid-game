<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Squid Game - Gestion des Joueurs</title>
  <style>
      @font-face {
          font-family: "GameOfSquids";
          src: url("https://ik.imagekit.io/lakolo/GameOfSquids-1GMVL.ttf?updatedAt=1737276103466");
      }
      @font-face {
          font-family: "PlayerFont";
          src: url("https://ik.imagekit.io/lakolo/JMH%20Beda.ttf?updatedAt=1736878741238");
      }

      body {
          font-family: "GameOfSquids", sans-serif;
          background-color: #101010;
          color: white;
          text-align: center;
          margin: 0;
          padding: 20px;
      }

      h1 {
          font-size: 3rem;
          margin: 20px 0;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          color: white;
      }

      h1 span {
          display: inline-block;
          font-family: "GameOfSquids", sans-serif;
          font-size: 3rem;
      }

      h1 span.shape-circle {
          color: #ff3e68;
      }

      h1 span.shape-triangle {
          color: #ff3e68;
      }

      /* Agrandir le carré pour qu’il paraisse plus proche en taille */
      h1 span.shape-square {
          color: #ff3e68;
          transform: scale(1.4);
          display: inline-block;
      }

      #players-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
      }

      .player-card {
          width: 80px;
          height: 120px;
          border: 2px solid white;
          border-radius: 5px;
          background-color: #007575;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          cursor: pointer;
          font-family: "PlayerFont", sans-serif;
          position: relative;
      }

      .player-card.active {
          border-color: limegreen;
          background-color: #0a0;
      }

      .player-card-number {
          font-size: 2rem;
          color: white;
          background-color: #005050;
          padding: 5px 10px;
          border: 2px solid white;
          border-radius: 5px;
      }

      .player-lives {
          font-size: 1.2rem;
          color: white;
          margin-top: 5px;
      }

      /* --- Boutons bien plus bas --- */
      .buttons-container {
          margin-top: 200px;  /* Ajuste cette valeur si tu veux les descendre encore plus */
      }

      button {
          padding: 10px 20px;
          font-size: 1.2rem;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 20px 10px;
          font-family: "GameOfSquids", sans-serif;
      }

      #submit-btn {
          background-color: #ff3e68;
          color: white;
      }
      #submit-btn:hover {
          background-color: #c32d4e;
      }

      #reset-btn {
          background-color: #32cd32;
          color: white;
      }
      #reset-btn:hover {
          background-color: #228b22;
      }

      #lives-input {
          padding: 10px;
          font-size: 1.2rem;
          border-radius: 5px;
          border: 1px solid #fff;
          margin: 20px;
          background-color: #202020;
          color: #fff;
      }

      /* Animation du coeur */
      .heart-animation {
          position: absolute;
          font-size: 2rem;
          color: red;
          z-index: 9999;
          pointer-events: none;
          opacity: 1;
      }

      /* Animation du "-X" lors de la perte de vie */
      .minus-life {
          position: absolute;
          color: red;
          font-size: 1.5rem;
          font-weight: bold;
          opacity: 1;
          transform: translate(-50%, 0);
          pointer-events: none;
      }
  </style>
</head>
<body>
  <h1>
      <span>SQUID</span>
      <span class="shape-circle">O</span>
      <span class="shape-triangle">Δ</span>
      <span class="shape-square">■</span>
      <span>GAME</span>
  </h1>
  <!-- Remplace le texte par "À qui le tour ?" -->
  <p>À qui le tour ?</p>

  <div id="players-container"></div>

  <!-- Conteneur pour les boutons, descendu via .buttons-container -->
  <div class="buttons-container">
      <input id="lives-input" type="number" placeholder="Vies à supprimer" min="1" />
      <button id="submit-btn" onclick="processRound()">Soumettre les gagnants</button>
      <!-- Au lieu de resetLives() direct, on met confirmReset() -->
      <button id="reset-btn" onclick="confirmReset()">Réinitialiser les vies</button>
      <button id="voice-btn" onclick="startVoiceRecognition()">Activer la Reconnaissance Vocale</button>
  </div>

  <script>
      // --- Tableau des joueurs (65 au lieu de 60) ---
      const players = Array.from({ length: 65 }, (_, i) => ({
          id: i + 1,
          lives: 6,
          isWinner: false,
      }));

      // === AUDIO avec fade-in / fade-out ===
      const audio = new Audio("https://ik.imagekit.io/lakolo/Squid%20Game%20%20Piggy%20Bank%20Scene.mp3?updatedAt=1737407404597");
      audio.volume = 1.0;
      let fadeInterval = null;

      // Démarre la musique avec un fade-in
      function playAudioFadeIn() {
          if (fadeInterval) clearInterval(fadeInterval);

          audio.pause();
          audio.currentTime = 0;
          audio.volume = 0; // commence à 0

          audio.play().catch(err => {
              console.warn("Impossible de jouer la musique :", err);
          });

          fadeInterval = setInterval(() => {
              if (audio.volume < 1) {
                  audio.volume = Math.min(audio.volume + 0.1, 1);
              } else {
                  clearInterval(fadeInterval);
                  fadeInterval = null;
              }
          }, 200);
      }

      // Arrête la musique avec un fade-out
      function stopAudioFadeOut() {
          if (fadeInterval) clearInterval(fadeInterval);

          fadeInterval = setInterval(() => {
              if (audio.volume > 0.1) {
                  audio.volume -= 0.1;
              } else {
                  audio.pause();
                  audio.currentTime = 0;
                  clearInterval(fadeInterval);
                  fadeInterval = null;
              }
          }, 200);
      }

      // --- Affichage des joueurs ---
      function renderPlayers() {
          const container = document.getElementById('players-container');
          container.innerHTML = '';
          players.forEach(player => {
              const playerCard = document.createElement('div');
              playerCard.className = 'player-card' + (player.isWinner ? ' active' : '');
              playerCard.onclick = () => toggleWinner(player.id);

              const playerNumber = document.createElement('div');
              playerNumber.className = 'player-card-number';
              playerNumber.textContent = player.id.toString().padStart(3, '0');

              const playerLives = document.createElement('div');
              playerLives.className = 'player-lives';
              playerLives.textContent = `Vies: ${player.lives}`;

              playerCard.appendChild(playerNumber);
              playerCard.appendChild(playerLives);
              container.appendChild(playerCard);
          });
      }

      // --- Marque / démarque un joueur comme gagnant ---
      function toggleWinner(playerId) {
          const player = players.find(p => p.id === playerId);
          if (player) {
              player.isWinner = !player.isWinner;
              renderPlayers();
          }
      }

      // --- Soumet les gagnants manuellement (bouton "Soumettre les gagnants") ---
      function processRound() {
          const livesToRemove = parseInt(document.getElementById('lives-input').value) || 1;
          players.forEach(player => {
              if (!player.isWinner && player.lives > 0) {
                  player.lives -= livesToRemove;
              }
              player.isWinner = false;
          });
          renderPlayers();
      }

      // --- Fenêtre de confirmation avant réinitialisation ---
      function confirmReset() {
          const sure = confirm("Êtes-vous sûr de vouloir réinitialiser toutes les vies ?");
          if (sure) {
              resetLives();
          }
      }

      // --- Réinitialise toutes les vies (appelée après confirmation) ---
      function resetLives() {
          players.forEach(player => {
              player.lives = 6;
              player.isWinner = false;
          });
          renderPlayers();
      }

      // --- Dictionnaire pour reconnaître certains mots comme nombres ---
      const spelledNumbers = {
          'un': 1, 'une': 1,
          'deux': 2, 'de': 2,
          'trois': 3,
          'quatre': 4,
          'cinq': 5,
          'six': 6,
          'sept': 7,
          'huit': 8,
          'neuf': 9,
          'dix': 10,
          'devis': 2,
          'paires': 2
      };

      // --- Transfert de vies + animation coeur ---
      function transferLives(donorId, receiverId, amount) {
          const donor = players.find(p => p.id === donorId);
          const receiver = players.find(p => p.id === receiverId);

          if (!donor || !receiver) {
              console.warn("Donneur ou receveur introuvable.");
              return;
          }
          if (donor.lives < amount) {
              console.warn(`Le joueur ${donorId} n'a pas assez de vies à donner.`);
              return;
          }

          donor.lives -= amount;
          receiver.lives += amount;
          renderPlayers();
          animateHeart(donorId, receiverId);
      }

      function animateHeart(donorId, receiverId) {
          const container = document.getElementById('players-container').children;
          let donorCard = null;
          let receiverCard = null;

          for (let card of container) {
              const numberDiv = card.querySelector('.player-card-number');
              const cardId = parseInt(numberDiv.textContent);
              if (cardId === donorId) donorCard = card;
              if (cardId === receiverId) receiverCard = card;
          }

          if (!donorCard || !receiverCard) return;

          const donorRect = donorCard.getBoundingClientRect();
          const receiverRect = receiverCard.getBoundingClientRect();

          const heartEl = document.createElement('div');
          heartEl.className = 'heart-animation';
          heartEl.textContent = '♥';
          document.body.appendChild(heartEl);

          // Position de départ
          heartEl.style.left = donorRect.left + donorRect.width / 2 + 'px';
          heartEl.style.top = donorRect.top + donorRect.height / 2 + 'px';

          const deltaX = (receiverRect.left + receiverRect.width / 2) - (donorRect.left + donorRect.width / 2);
          const deltaY = (receiverRect.top + receiverRect.height / 2) - (donorRect.top + donorRect.height / 2);

          heartEl.animate([
              { transform: 'translate(0, 0)', opacity: 1 },
              { transform: `translate(${deltaX}px, ${deltaY}px)`, opacity: 1 }
          ], {
              duration: 1000,
              easing: 'ease-in-out'
          }).onfinish = () => {
              document.body.removeChild(heartEl);
          };
      }

      // --- Afficher "-X" quand un joueur perd des vies ---
      function showMinusLife(playerId, lostValue) {
          const container = document.getElementById('players-container').children;
          let card = null;
          for (let c of container) {
              const numberDiv = c.querySelector('.player-card-number');
              const cardId = parseInt(numberDiv.textContent);
              if (cardId === playerId) {
                  card = c;
                  break;
              }
          }
          if (!card) return;

          const rect = card.getBoundingClientRect();
          const minusEl = document.createElement('div');
          minusEl.className = 'minus-life';
          minusEl.textContent = `-${lostValue}`;

          document.body.appendChild(minusEl);
          minusEl.style.left = (rect.left + rect.width / 2) + 'px';
          minusEl.style.top = rect.top + 'px';

          minusEl.animate([
              { transform: 'translate(-50%, 0)', opacity: 1 },
              { transform: 'translate(-50%, -50px)', opacity: 0 }
          ], {
              duration: 1000,
              easing: 'ease-out'
          }).onfinish = () => {
              document.body.removeChild(minusEl);
          };
      }

      // --- Reconnaissance vocale ---
      function startVoiceRecognition() {
          if (!('webkitSpeechRecognition' in window)) {
              console.error('La reconnaissance vocale n’est pas prise en charge par ce navigateur.');
              return;
          }

          const recognition = new webkitSpeechRecognition();
          recognition.lang = 'fr-FR';
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;
          recognition.continuous = true;
          recognition.start();

          recognition.onresult = (event) => {
              const result = event.results[event.results.length - 1][0].transcript.toLowerCase();
              console.log('Reconnaissance vocale:', result);

              // (A) Retirer tous les gagnants
              if (
                  result.includes('retire moi tous les numéros') ||
                  result.includes('retire-moi tous les numéros') ||
                  result.includes('retiens-moi tous les numéros') ||
                  result.includes('rupture moi tous les numéros')
              ) {
                  players.forEach(player => player.isWinner = false);
                  renderPlayers();
              }

              // (B) "gagnant" => fade-in de la musique
              if (result.includes('gagnant')) {
                  stopAudioFadeOut();
                  playAudioFadeIn();
              }

              // (C) "les autres perdront (\d+)"
              const perdrontMatch = result.match(/les autres perdront (\d+)/i);
              if (perdrontMatch) {
                  stopAudioFadeOut();
                  const livesToRemove = parseInt(perdrontMatch[1], 10);
                  players.forEach(player => {
                      if (!player.isWinner && player.lives > 0) {
                          player.lives -= livesToRemove;
                          showMinusLife(player.id, livesToRemove);
                      }
                      player.isWinner = false;
                  });
                  renderPlayers();
              }

              // (D) "les autres perdent X vies"
              if (result.includes('les autres perdent')) {
                  stopAudioFadeOut();
                  const spelledRegex = /les autres perdent (un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i;
                  const spelledMatch = result.match(spelledRegex);
                  if (spelledMatch) {
                      let val = spelledMatch[1];
                      if (spelledNumbers[val] !== undefined) {
                          val = spelledNumbers[val];
                      } else {
                          val = parseInt(val, 10);
                      }
                      players.forEach(player => {
                          if (!player.isWinner && player.lives > 0) {
                              player.lives -= val;
                              showMinusLife(player.id, val);
                          }
                          player.isWinner = false;
                      });
                      renderPlayers();
                  }
              }

              // (E) "les autres paires de vie" => retire 2 vies
              if (result.includes('les autres paires de vie')) {
                  stopAudioFadeOut();
                  const val = 2;
                  players.forEach(player => {
                      if (!player.isWinner && player.lives > 0) {
                          player.lives -= val;
                          showMinusLife(player.id, val);
                      }
                      player.isWinner = false;
                  });
                  renderPlayers();
              }

              // (E BIS) "les autres paires de devis" => retire 2 vies
              if (result.includes('les autres paires de devis')) {
                  stopAudioFadeOut();
                  const val = 2; // on retire 2, comme demandé
                  players.forEach(player => {
                      if (!player.isWinner && player.lives > 0) {
                          player.lives -= val;
                          showMinusLife(player.id, val);
                      }
                      player.isWinner = false;
                  });
                  renderPlayers();
              }

              // (F) "tu peux me transférer" -> logique flexible
              if (result.includes('tu peux me transférer')) {
                  const amountMatch = result.match(/(un|une|deux|de|trois|quatre|cinq|six|sept|huit|neuf|dix|devis|paires|\d+)/i);
                  if (!amountMatch) return;

                  let amountRaw = amountMatch[1].toLowerCase();
                  let amountVal = spelledNumbers[amountRaw] !== undefined
                      ? spelledNumbers[amountRaw]
                      : parseInt(amountRaw, 10);

                  const digits = result.match(/\d+/g);
                  if (!digits || digits.length < 2) {
                      console.warn("Pas assez de nombres pour détecter donneur et receveur.");
                      return;
                  }
                  const donorId = parseInt(digits[0], 10);
                  const receiverId = parseInt(digits[1], 10);

                  transferLives(donorId, receiverId, amountVal);
                  return;
              }

              // (G) Sélectionner des gagnants par numéro
              const matches = result.match(/\d+/g);
              if (matches) {
                  matches.forEach(num => {
                      const playerId = parseInt(num, 10);
                      const player = players.find(p => p.id === playerId);
                      if (player) {
                          player.isWinner = true;
                      }
                  });
                  renderPlayers();
              }
          };

          recognition.onerror = (event) => {
              console.error('Erreur de reconnaissance vocale:', event.error);
          };

          recognition.onend = () => {
              recognition.start();
          };
      }

      // Lance l'affichage initial
      renderPlayers();
  </script>
</body>
</html>
